name: Sanity Check

on:
  workflow_call:
    inputs:
      project-type:
        description: 'Project type (laravel, vue, react, dart, flutter, auto)'
        type: string
        default: 'auto'
      php-version:
        description: 'PHP version'
        type: string
        default: '8.3'
      node-version:
        description: 'Node.js version'
        type: string
        default: '20'
      flutter-version:
        description: 'Flutter version'
        type: string
        default: '3.38.4'
      # Vue/JS checks
      vue-max-loc:
        description: 'Max lines of code for Vue files'
        type: number
        default: 700
      vue-exclude-patterns:
        description: 'Glob patterns to exclude from Vue LOC check (comma-separated)'
        type: string
        default: ''
      check-native-inputs:
        description: 'Check for native HTML inputs (should use shadcn/ui)'
        type: boolean
        default: true
      check-vue-types:
        description: 'Check for type definitions inside .vue files'
        type: boolean
        default: true
      # Laravel checks
      check-missing-requests:
        description: 'Check for missing FormRequest classes'
        type: boolean
        default: true
      check-column-mismatches:
        description: 'Check for column name mismatches'
        type: boolean
        default: true
      check-relationship-conflicts:
        description: 'Check for property/relationship name conflicts'
        type: boolean
        default: true
      laravel-exclude-patterns:
        description: 'Patterns to exclude from Laravel checks (comma-separated)'
        type: string
        default: ''
      # Dart/Flutter checks
      dart-max-file-size:
        description: 'Max Dart file size in KB'
        type: number
        default: 18
      dart-max-loc:
        description: 'Max lines of code for Dart files'
        type: number
        default: 600
      dart-exclude-patterns:
        description: 'Glob patterns to exclude from Dart checks (comma-separated)'
        type: string
        default: ''
      # Asset checks
      check-assets:
        description: 'Check for non-optimized assets'
        type: boolean
        default: true
      # Comment settings
      post-comment:
        description: 'Post findings as PR comment'
        type: boolean
        default: true
      fail-on-issues:
        description: 'Fail the workflow if issues are found'
        type: boolean
        default: true

jobs:
  detect:
    name: Detect Project Type
    runs-on: ubuntu-latest
    outputs:
      project-type: ${{ steps.detect.outputs.type }}
      has-vue: ${{ steps.detect.outputs.has_vue }}
      has-laravel: ${{ steps.detect.outputs.has_laravel }}
      has-dart: ${{ steps.detect.outputs.has_dart }}
      has-assets: ${{ steps.detect.outputs.has_assets }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        run: |
          TYPE="${{ inputs.project-type }}"

          if [ "$TYPE" = "auto" ]; then
            if [ -f "artisan" ]; then
              TYPE="laravel"
            elif [ -f "pubspec.yaml" ]; then
              if grep -q "flutter:" pubspec.yaml; then
                TYPE="flutter"
              else
                TYPE="dart"
              fi
            elif [ -f "package.json" ]; then
              if grep -q '"vue"' package.json; then
                TYPE="vue"
              elif grep -q '"react"' package.json; then
                TYPE="react"
              else
                TYPE="node"
              fi
            fi
          fi

          echo "type=$TYPE" >> $GITHUB_OUTPUT

          # Check what we have
          [ -d "resources/js" ] && [ -f "package.json" ] && echo "has_vue=true" >> $GITHUB_OUTPUT || echo "has_vue=false" >> $GITHUB_OUTPUT
          [ -f "artisan" ] && echo "has_laravel=true" >> $GITHUB_OUTPUT || echo "has_laravel=false" >> $GITHUB_OUTPUT
          [ -f "pubspec.yaml" ] && echo "has_dart=true" >> $GITHUB_OUTPUT || echo "has_dart=false" >> $GITHUB_OUTPUT

          # Check for assets
          if find . -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.svg" \) 2>/dev/null | head -1 | grep -q .; then
            echo "has_assets=true" >> $GITHUB_OUTPUT
          else
            echo "has_assets=false" >> $GITHUB_OUTPUT
          fi

          echo "üì¶ Detected project type: $TYPE"

  vue-checks:
    name: Vue/JS Checks
    needs: detect
    if: needs.detect.outputs.has-vue == 'true'
    runs-on: ubuntu-latest
    outputs:
      findings: ${{ steps.collect.outputs.findings }}
      has-issues: ${{ steps.collect.outputs.has_issues }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download sanity scripts
        uses: actions/checkout@v4
        with:
          repository: banua-coder/banua-coder-workflow
          path: .sanity-scripts
          sparse-checkout: scripts
          sparse-checkout-cone-mode: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Check Vue file LOC
        id: vue-loc
        run: |
          MAX_LOC=${{ inputs.vue-max-loc }}
          EXCLUDE_PATTERNS="${{ inputs.vue-exclude-patterns }}"
          FAILED_FILES=""

          echo "## üìè Vue File Size Check" >> findings.md
          echo "" >> findings.md
          echo "| File | Lines | Status |" >> findings.md
          echo "|------|-------|--------|" >> findings.md

          while IFS= read -r file; do
            [ -z "$file" ] && continue

            # Check if file matches any exclude pattern
            SKIP=false
            if [ -n "$EXCLUDE_PATTERNS" ]; then
              IFS=',' read -ra PATTERNS <<< "$EXCLUDE_PATTERNS"
              for pattern in "${PATTERNS[@]}"; do
                pattern=$(echo "$pattern" | xargs) # trim whitespace
                if [[ "$file" == *"$pattern"* ]]; then
                  SKIP=true
                  break
                fi
              done
            fi

            if [ "$SKIP" = "true" ]; then
              continue
            fi

            LOC=$(wc -l < "$file" | tr -d ' ')
            if [ "$LOC" -gt "$MAX_LOC" ]; then
              echo "| \`$file\` | **$LOC** | ‚ùå Exceeds $MAX_LOC |" >> findings.md
              FAILED_FILES="$FAILED_FILES$file ($LOC lines)\n"
            fi
          done < <(find resources/js -name "*.vue" -type f 2>/dev/null)

          if [ -n "$FAILED_FILES" ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "" >> findings.md
            echo "> **Action Required:** Split these files into smaller components" >> findings.md
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "" >> findings.md
            echo "‚úÖ All Vue files are within the $MAX_LOC line limit" >> findings.md
          fi
          echo "" >> findings.md

      - name: Check for native HTML inputs
        if: inputs.check-native-inputs
        id: native-inputs
        run: |
          echo "## üîç Native Input Check" >> findings.md
          echo "" >> findings.md

          SCRIPT_PATH=".sanity-scripts/scripts/check-native-inputs.cjs"
          if [ -f "$SCRIPT_PATH" ]; then
            OUTPUT=$(node "$SCRIPT_PATH" 2>&1) || true
            if [ -n "$OUTPUT" ]; then
              echo "$OUTPUT" >> findings.md
            else
              echo "‚úÖ No native HTML inputs found outside ui components" >> findings.md
            fi
          else
            # Fallback to inline check
            ISSUES=""
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              if grep -n '<input\|<select\|<textarea' "$file" 2>/dev/null | grep -v 'components/ui' | head -5 > /tmp/matches; then
                if [ -s /tmp/matches ]; then
                  ISSUES="$ISSUES\n**$file:**\n\`\`\`\n$(cat /tmp/matches)\n\`\`\`\n"
                fi
              fi
            done < <(find resources/js/pages resources/js/components -name "*.vue" -type f 2>/dev/null | grep -v 'components/ui')

            if [ -n "$ISSUES" ]; then
              echo "Found native HTML inputs that should use shadcn-vue components:" >> findings.md
              echo -e "$ISSUES" >> findings.md
              echo "> **Suggestion:** Replace with components from \`@/components/ui\`" >> findings.md
            else
              echo "‚úÖ No native HTML inputs found outside ui components" >> findings.md
            fi
          fi
          echo "" >> findings.md

      - name: Check for Vue type definitions
        if: inputs.check-vue-types
        id: vue-types
        run: |
          echo "## üîç Vue Types Check" >> findings.md
          echo "" >> findings.md

          SCRIPT_PATH=".sanity-scripts/scripts/check-vue-types.sh"
          if [ -f "$SCRIPT_PATH" ]; then
            OUTPUT=$(bash "$SCRIPT_PATH" 2>&1) || true
            if [ -n "$OUTPUT" ]; then
              echo "$OUTPUT" >> findings.md
            else
              echo "‚úÖ No type definitions found inside .vue files" >> findings.md
            fi
          else
            # Fallback: Check for interface/type definitions in .vue files
            ISSUES=""
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              if grep -n '^\s*\(export \)\?\(interface\|type\) ' "$file" 2>/dev/null | head -5 > /tmp/matches; then
                if [ -s /tmp/matches ]; then
                  ISSUES="$ISSUES\n**$file:**\n\`\`\`\n$(cat /tmp/matches)\n\`\`\`\n"
                fi
              fi
            done < <(find resources/js -name "*.vue" -type f 2>/dev/null)

            if [ -n "$ISSUES" ]; then
              echo "Found type definitions inside .vue files (should be in separate .ts files):" >> findings.md
              echo -e "$ISSUES" >> findings.md
              echo "> **Suggestion:** Move type definitions to dedicated .ts files" >> findings.md
            else
              echo "‚úÖ No type definitions found inside .vue files" >> findings.md
            fi
          fi
          echo "" >> findings.md

      - name: Collect findings
        id: collect
        run: |
          if [ -f findings.md ]; then
            # Escape for JSON
            FINDINGS=$(cat findings.md | jq -Rs .)
            echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
          else
            echo 'findings=""' >> $GITHUB_OUTPUT
          fi

          if [ "${{ steps.vue-loc.outputs.has_issues }}" = "true" ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: vue-findings
          path: findings.md
          retention-days: 1
          if-no-files-found: ignore

  laravel-checks:
    name: Laravel Checks
    needs: detect
    if: needs.detect.outputs.has-laravel == 'true'
    runs-on: ubuntu-latest
    outputs:
      findings: ${{ steps.collect.outputs.findings }}
      has-issues: ${{ steps.collect.outputs.has_issues }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download sanity scripts
        uses: actions/checkout@v4
        with:
          repository: banua-coder/banua-coder-workflow
          path: .sanity-scripts
          sparse-checkout: scripts
          sparse-checkout-cone-mode: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}

      - name: Run Laravel checks
        id: laravel-checks
        run: |
          HAS_ISSUES=false
          echo "## üîß Laravel Checks" >> findings.md
          echo "" >> findings.md

          # Check for missing FormRequest classes
          if [ "${{ inputs.check-missing-requests }}" = "true" ]; then
            echo "### FormRequest Check" >> findings.md
            echo "" >> findings.md

            SCRIPT_PATH=".sanity-scripts/scripts/check-missing-requests.php"
            if [ -f "$SCRIPT_PATH" ]; then
              OUTPUT=$(php "$SCRIPT_PATH" 2>&1) || true
              if [ -n "$OUTPUT" ]; then
                echo "$OUTPUT" >> findings.md
                HAS_ISSUES=true
              else
                echo "‚úÖ All controllers use proper FormRequest classes" >> findings.md
              fi
            else
              # Fallback to inline check
              MISSING=""
              for controller in app/Http/Controllers/*.php app/Http/Controllers/**/*.php; do
                [ -f "$controller" ] || continue
                if grep -l 'public function store\|public function update' "$controller" 2>/dev/null | head -1 > /dev/null; then
                  if grep -E 'function (store|update)\(Request \$request' "$controller" 2>/dev/null; then
                    MISSING="$MISSING- \`$controller\`: Uses generic Request instead of FormRequest\n"
                  fi
                fi
              done

              if [ -n "$MISSING" ]; then
                echo -e "$MISSING" >> findings.md
                echo "> **Suggestion:** Create dedicated FormRequest classes for validation" >> findings.md
                HAS_ISSUES=true
              else
                echo "‚úÖ All controllers use proper FormRequest classes" >> findings.md
              fi
            fi
            echo "" >> findings.md
          fi

          # Check for column mismatches
          if [ "${{ inputs.check-column-mismatches }}" = "true" ]; then
            echo "### Column Mismatch Check" >> findings.md
            echo "" >> findings.md

            SCRIPT_PATH=".sanity-scripts/scripts/check-column-mismatches.php"
            if [ -f "$SCRIPT_PATH" ]; then
              OUTPUT=$(php "$SCRIPT_PATH" 2>&1) || true
              if [ -n "$OUTPUT" ]; then
                echo "$OUTPUT" >> findings.md
                HAS_ISSUES=true
              else
                echo "‚úÖ No column mismatches found" >> findings.md
              fi
            else
              echo "‚ö†Ô∏è Script not found" >> findings.md
            fi
            echo "" >> findings.md
          fi

          # Check for relationship conflicts
          if [ "${{ inputs.check-relationship-conflicts }}" = "true" ]; then
            echo "### Relationship Conflict Check" >> findings.md
            echo "" >> findings.md

            SCRIPT_PATH=".sanity-scripts/scripts/check-relationship-conflicts.php"
            if [ -f "$SCRIPT_PATH" ]; then
              OUTPUT=$(php "$SCRIPT_PATH" 2>&1) || true
              if [ -n "$OUTPUT" ]; then
                echo "$OUTPUT" >> findings.md
                HAS_ISSUES=true
              else
                echo "‚úÖ No relationship conflicts found" >> findings.md
              fi
            else
              echo "‚ö†Ô∏è Script not found" >> findings.md
            fi
            echo "" >> findings.md
          fi

          echo "has_issues=$HAS_ISSUES" >> $GITHUB_OUTPUT

      - name: Collect findings
        id: collect
        run: |
          if [ -f findings.md ]; then
            FINDINGS=$(cat findings.md | jq -Rs .)
            echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
          else
            echo 'findings=""' >> $GITHUB_OUTPUT
          fi
          echo "has_issues=${{ steps.laravel-checks.outputs.has_issues }}" >> $GITHUB_OUTPUT

      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: laravel-findings
          path: findings.md
          retention-days: 1
          if-no-files-found: ignore

  dart-checks:
    name: Dart/Flutter Checks
    needs: detect
    if: needs.detect.outputs.has-dart == 'true'
    runs-on: ubuntu-latest
    outputs:
      findings: ${{ steps.collect.outputs.findings }}
      has-issues: ${{ steps.collect.outputs.has_issues }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Dart file sizes
        id: dart-checks
        run: |
          MAX_SIZE=${{ inputs.dart-max-file-size }}
          MAX_LOC=${{ inputs.dart-max-loc }}
          EXCLUDE_PATTERNS="${{ inputs.dart-exclude-patterns }}"
          HAS_ISSUES=false

          echo "## üìè Dart File Size Check" >> findings.md
          echo "" >> findings.md
          echo "| File | Size (KB) | Lines | Status |" >> findings.md
          echo "|------|-----------|-------|--------|" >> findings.md

          while IFS= read -r file; do
            [ -z "$file" ] && continue

            # Check if file matches any exclude pattern
            SKIP=false
            if [ -n "$EXCLUDE_PATTERNS" ]; then
              IFS=',' read -ra PATTERNS <<< "$EXCLUDE_PATTERNS"
              for pattern in "${PATTERNS[@]}"; do
                pattern=$(echo "$pattern" | xargs)
                if [[ "$file" == *"$pattern"* ]]; then
                  SKIP=true
                  break
                fi
              done
            fi

            if [ "$SKIP" = "true" ]; then
              continue
            fi

            SIZE_KB=$(du -k "$file" | cut -f1)
            LOC=$(wc -l < "$file" | tr -d ' ')

            if [ "$SIZE_KB" -gt "$MAX_SIZE" ] || [ "$LOC" -gt "$MAX_LOC" ]; then
              STATUS="‚ùå"
              [ "$SIZE_KB" -gt "$MAX_SIZE" ] && STATUS="$STATUS Size>${MAX_SIZE}KB"
              [ "$LOC" -gt "$MAX_LOC" ] && STATUS="$STATUS LOC>$MAX_LOC"
              echo "| \`$file\` | $SIZE_KB | $LOC | $STATUS |" >> findings.md
              HAS_ISSUES=true
            fi
          done < <(find lib -name "*.dart" -type f 2>/dev/null)

          if [ "$HAS_ISSUES" = "false" ]; then
            echo "" >> findings.md
            echo "‚úÖ All Dart files are within limits" >> findings.md
          fi
          echo "" >> findings.md
          echo "has_issues=$HAS_ISSUES" >> $GITHUB_OUTPUT

      - name: Collect findings
        id: collect
        run: |
          if [ -f findings.md ]; then
            FINDINGS=$(cat findings.md | jq -Rs .)
            echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
          else
            echo 'findings=""' >> $GITHUB_OUTPUT
          fi
          echo "has_issues=${{ steps.dart-checks.outputs.has_issues }}" >> $GITHUB_OUTPUT

      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: dart-findings
          path: findings.md
          retention-days: 1
          if-no-files-found: ignore

  comment:
    name: Post Findings
    needs: [detect, vue-checks, laravel-checks, dart-checks]
    if: always() && github.event_name == 'pull_request' && inputs.post-comment
    runs-on: ubuntu-latest
    steps:
      - name: Download all findings
        uses: actions/download-artifact@v4
        with:
          pattern: '*-findings'
          merge-multiple: true
        continue-on-error: true

      - name: Combine findings
        id: combine
        run: |
          echo "# üîç Sanity Check Report" > combined.md
          echo "" >> combined.md

          HAS_ANY_ISSUES=false

          # Check job results
          if [ "${{ needs.vue-checks.outputs.has-issues }}" = "true" ]; then
            HAS_ANY_ISSUES=true
          fi
          if [ "${{ needs.laravel-checks.outputs.has-issues }}" = "true" ]; then
            HAS_ANY_ISSUES=true
          fi
          if [ "${{ needs.dart-checks.outputs.has-issues }}" = "true" ]; then
            HAS_ANY_ISSUES=true
          fi

          # Combine all findings files
          for f in *.md; do
            if [ -f "$f" ] && [ "$f" != "combined.md" ]; then
              cat "$f" >> combined.md
              echo "" >> combined.md
            fi
          done

          if [ "$HAS_ANY_ISSUES" = "true" ]; then
            echo "" >> combined.md
            echo "---" >> combined.md
            echo "‚ö†Ô∏è **Issues found.** Please address the items marked with ‚ùå" >> combined.md
          else
            echo "" >> combined.md
            echo "---" >> combined.md
            echo "‚úÖ **All sanity checks passed!**" >> combined.md
          fi

          echo "has_issues=$HAS_ANY_ISSUES" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('combined.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üîç Sanity Check Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Fail if issues found
        if: inputs.fail-on-issues && steps.combine.outputs.has_issues == 'true'
        run: |
          echo "::error::Sanity check found issues. See PR comment for details."
          exit 1
